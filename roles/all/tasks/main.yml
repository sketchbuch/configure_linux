- name: 'Set real_username'
  set_fact:
      real_username: '{{ansible_facts["env"]["SUDO_USER"]}}'
  tags: set_fact

- name: 'Set is_virtual'
  set_fact:
      is_virtual: ansible_virtualization_role == 'guest'
  tags: set_fact

# Stop the include_vars task from comlaining about tmp folder perms
- name: 'Create .ansible/tmp folder"'
  become: true
  become_user: '{{real_username}}'
  file:
    group: '{{real_username}}'
    mode: '0644'
    owner: '{{real_username}}'
    path: "~/.ansible/tmp"
    state: directory
  tags: setup,folders


# Loads vars from the vars folder for this role
- include_vars: "all.yml"
  tags: always

- block:
  - name: 'Gather package facts'
    ansible.builtin.package_facts:
      manager: auto
    when: collect_package_facts is defined and collect_package_facts == true
    tags: pkg_facts

  - name: 'Print package facts'
    ansible.builtin.debug:
      var: ansible_facts.packages
    when:
      - collect_package_facts is defined and collect_package_facts == true
      - debug_package_facts is defined and debug_package_facts == true
    tags: pkg_facts
    
  - name: 'Checking required package: Flatpak'
    ansible.builtin.assert:
      that:
        - ansible_facts.packages['flatpak'] is defined
      fail_msg: 'Flatpak must be installed since a restart is required'
      success_msg: 'Flatpak is installed'
    tags: dep_check
  
  rescue:
    - set_fact: all_task_failed=true